- name: Deploy docker-compose
  hosts: all
  become: true

  tasks:
    - name: Debug environment variables
      ansible.builtin.shell: |
        echo "POSTGRES_USER=${POSTGRES_USER}"
        echo "POSTGRES_PASSWORD=${POSTGRES_PASSWORD}"
        echo "POSTGRES_DB=${POSTGRES_DB}"
        echo "ADMIN_USER=${ADMIN_USER}"
        echo "ADMIN_PASSWORD=${ADMIN_PASSWORD}"
        echo "ADMIN_EMAIL=${ADMIN_EMAIL}"
        echo "AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}"
        echo "AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}"
        echo "AWS_REGION=${AWS_REGION}"
        echo "S3_BUCKET_NAME=${S3_BUCKET_NAME}"
      register: env_output
    - debug:
        var: env_output.stdout

    - name: Copy docker-compose.yml file
      ansible.builtin.copy:
        src: ../docker-compose.yml
        dest: /home/ubuntu/docker-compose.yml
        owner: root
        group: root
        mode: '0644'

    - name: Run docker compose file
      community.docker.docker_compose_v2:
        project_src: /home/ubuntu
        state: present
        build: always
        pull: missing
        recreate: always
        remove_orphans: true
        timeout: 60
        project_name: speardevs_packeton
        files:
          - docker-compose.yml
        environment:
          POSTGRES_USER: "{{ POSTGRES_USER }}"
          POSTGRES_PASSWORD: "{{ POSTGRES_PASSWORD }}"
          POSTGRES_DB: "{{ POSTGRES_DB }}"
          ADMIN_USER: "{{ ADMIN_USER }}"
          ADMIN_PASSWORD: "{{ ADMIN_PASSWORD }}"
          ADMIN_EMAIL: "{{ ADMIN_EMAIL }}"
          AWS_ACCESS_KEY_ID: "{{ AWS_ACCESS_KEY_ID }}"
          AWS_SECRET_ACCESS_KEY: "{{ AWS_SECRET_ACCESS_KEY }}"
          AWS_REGION: "{{ AWS_REGION }}"
          S3_BUCKET_NAME: "{{ S3_BUCKET_NAME }}"


    - name: Ensure docker-compose is running
      ansible.builtin.systemd:
        name: docker-compose@speardevs_packeton
        state: started
        enabled: true

    - name: Remove docker-compose.yml file
      ansible.builtin.file:
        path: /home/ubuntu/docker-compose.yml
        state: absent

    - name: Copy .env.local file
      community.docker.docker_container_copy_into:
        name: speardevs_packeton_packeton
        path: .env.local
        container_path: /data/.env.local
